name: Resource Groups

on:
  workflow_dispath:
    inputs:
      subscriptionsTarget:
        type: choice
        description: subscriptionsTarget
        options:
          - mgmt
          - conn
          - iden

jobs:
  Build:
    uses: example-org/example-repo/.github/workflows/job-codeBuild.workflow.yml@main
    with:
      publish_artifacts: 'yes'

  Preview:
    needs: Build
    if: success()
    runs-on: ${{ secrets.AGENT_WIN }}
    environment: PlatformPreview
    env:
       # RG 
      templatePath : './Modules/Microsoft.Resources/resourceGroups/resourceGroups.deploy.json'
      templateParameterPath: './Configuration/${{ secrets.ENV_PREFIX }}/Microsoft.Resources-resourceGroups/platform-${{ github.event.inputs.subscriptionsTarget }}-rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}.parameters.json'
       # locks
      templatelockPath: './Modules/Microsoft.Authorization/locks/locks.deploy.json'
      templatelockParameterPath: './Configuration/${{ secrets.ENV_PREFIX }}/Microsoft.Authorization-locks'

    steps:
      # Download a Build Artifact
      - name: Download a Build Artifact
        uses: actions/download-artifact@v2.0.10
        with:
          name: BuildArtifacts

      # Azure Login
      - name: Azure Login
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_SP_MG }}
          allow-no-subscriptions: true
          enable-AzPSSession: true

      # Deploy RG for MGMT
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'mgmt' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_MGMT_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Deploy RG for Conn
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'conn' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_CONN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Deploy RG for Identity
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'iden' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_IDEN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest           

      # Add CONN RG lock 
      - name: Add Conn RG lock
        if: ${{ github.event.inputs.subscriptionsTarget == 'conn' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-dnsfwd-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-exthub-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-inthub-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-ipgroups-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-paasdns-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-plsspoke-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-vmimages-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-workbooks-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_CONN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest

      # Add IDEN RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'iden' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_IDEN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest       

      # Add mgmt RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'mgmt' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platformlogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-splunkintegration-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_MGMT_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest           
         
  ComponentsTest:
    needs: Preview
    if: success()
    runs-on: ${{ secrets.AGENT_WIN }}

    steps:
      - name: Components Test
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/Pester/invokePester.ps1 `
              -testSubDirectory ConfigFileTests `
              -tagArray @("Microsoft.Resources-resourceGroups","Microsoft.Authorization-locks")
          azPSVersion: latest

      - name: Publish Unit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1
        if: always()
        with:
          files: '**/TEST-*.xml'
              

  NonProduction:
    needs: ComponentsTest
    if: ${{ success() && github.ref_name == 'main' }}
    runs-on: ${{ secrets.AGENT_WIN }}
    environment: PlatformNonProduction
    env:
       # RG 
      templatePath : './Modules/Microsoft.Resources/resourceGroups/resourceGroups.deploy.json'
      templateParameterPath: './Configuration/${{ secrets.ENV_PREFIX }}/Microsoft.Resources-resourceGroups/platform-${{ github.event.inputs.subscriptionsTarget }}-rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}.parameters.json'
       # locks
      templatelockPath: './Modules/Microsoft.Authorization/locks/locks.deploy.json'
      templatelockParameterPath: './Configuration/${{ secrets.ENV_PREFIX }}/Microsoft.Authorization-locks'

    steps:
      # Download a Build Artifact
      - name: Download a Build Artifact
        uses: actions/download-artifact@v2.0.10
        with:
          name: BuildArtifacts

      # Azure Login
      - name: Azure Login
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_SP_MG }}
          allow-no-subscriptions: true
          enable-AzPSSession: true
      
      # Deploy RG for MGMT
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'mgmt' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_MGMT_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Deploy RG for Conn
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'conn' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_CONN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Deploy RG for Identity
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'iden' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_IDEN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Add CONN RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'conn' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-dnsfwd-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-exthub-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-inthub-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-ipgroups-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-paasdns-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-plsspoke-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-vmimages-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-workbooks-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_CONN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest

      # Add IDEN RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'iden' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_IDEN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest       

      # Add mgmt RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'mgmt' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platformlogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-splunkintegration-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_MGMT_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest  

  Production:
    needs: NonProduction
    if: ${{ success() && github.ref_name == 'main' }}
    runs-on: ${{ secrets.AGENT_WIN }}
    environment: PlatformProduction
    env:      
      # RG 
      templatePath : './Modules/Microsoft.Resources/resourceGroups/resourceGroups.deploy.json'
      templateParameterPath: './Configuration/${{ secrets.ENV_PREFIX }}/Microsoft.Resources-resourceGroups/platform-${{ github.event.inputs.subscriptionsTarget }}-rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}.parameters.json'
       # locks
      templatelockPath: './Modules/Microsoft.Authorization/locks/locks.deploy.json'
      templatelockParameterPath: './Configuration/${{ secrets.ENV_PREFIX }}/Microsoft.Authorization-locks'

    steps:
      # Download a Build Artifact
      - name: Download a Build Artifact
        uses: actions/download-artifact@v2.0.10
        with:
          name: BuildArtifacts

      # Azure Login
      - name: Azure Login
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_SP_MG }}
          allow-no-subscriptions: true
          enable-AzPSSession: true
      
      # Deploy RG for MGMT
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'mgmt' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_MGMT_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Deploy RG for Conn
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'conn' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_CONN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Deploy RG for Identity
      - name : Deploy Resource Groups
        if: ${{ github.event.inputs.subscriptionsTarget == 'iden' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatePath }} `
              -templateParametersFile ${{ env.templateParameterPath }} `
              -location $(secrets.PRIMARY_REGION) `
              -subscriptionId ${{ secrets.SUB_IDEN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}"
          azPSVersion: latest

      # Add CONN RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'conn' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-dnsfwd-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-exthub-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-inthub-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-ipgroups-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-paasdns-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-plsspoke-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-vmimages-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-workbooks-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_CONN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest

      # Add IDEN RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'iden' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_IDEN_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest       

      # Add mgmt RG lock 
      - name: Add Conn RG lock 
        if: ${{ github.event.inputs.subscriptionsTarget == 'mgmt' }}
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            ./Scripts/New-DeploymentV2.ps1 `
              -templateFile ${{ env.templatelockPath }} `
              -templateParametersFile ${{ env.templatelockParameterPath }} `
              -resourceGroupName "rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platform-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-platformlogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-seclogs-01,`
                                  rg-${{ secrets.PRIMARY_REGION_PREFIX }}-${{ secrets.ENV_PREFIX }}-splunkintegration-01,`
                                  NetworkWatcherRG" `
              -subscriptionId ${{ secrets.SUB_MGMT_ID }} `
              -buildInfo "${{ github.sha }} ${{ github.ref_name }}" `
              -skipTags `
              -rgLocks
          azPSVersion: latest  